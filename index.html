<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>–ú–∞–≥–∞–∑–∏–Ω</title>

    <!-- 1. Telegram WebApp SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <!-- 2. TON Connect UI (–æ–±—ã—á–Ω—ã–π, –ù–ï React) -->
    <script src="https://unpkg.com/@tonconnect/ui@2.0.5/dist/tonconnect-ui.min.js"></script>

    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }

        :root {
            --bg: #0f1117;
            --card: #1a1d27;
            --accent: #6c5ce7;
            --accent-hover: #7d6ff0;
            --green: #00b894;
            --red: #e17055;
            --text: #f1f1f1;
            --text-dim: #9ca3af;
            --border: #2d3041;
            --radius: 16px;
        }

        body {
            padding: 16px;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
        }

        main {
            max-width: 440px;
            margin: 0 auto;
        }

        /* === HEADER === */
        header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }
        .header-left {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        header h1 {
            font-size: 22px;
            font-weight: 700;
        }
        header span.logo {
            font-size: 24px;
        }

        /* User greeting */
        #user-greeting {
            font-size: 12px;
            color: var(--text-dim);
        }

        /* === SEARCH === */
        .search-bar {
            width: 100%;
            padding: 10px 14px;
            border-radius: var(--radius);
            border: 1px solid var(--border);
            background: var(--card);
            color: var(--text);
            font-size: 14px;
            margin-bottom: 12px;
            outline: none;
            transition: border-color 0.2s;
        }
        .search-bar:focus {
            border-color: var(--accent);
        }
        .search-bar::placeholder {
            color: var(--text-dim);
        }

        /* === CATEGORY TABS === */
        .category-tabs {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding-bottom: 8px;
            margin-bottom: 14px;
            scrollbar-width: none;
        }
        .category-tabs::-webkit-scrollbar { display: none; }
        .cat-tab {
            padding: 6px 14px;
            border-radius: 999px;
            font-size: 12px;
            font-weight: 600;
            border: 1px solid var(--border);
            background: var(--card);
            color: var(--text-dim);
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.2s;
        }
        .cat-tab.active {
            background: var(--accent);
            color: #fff;
            border-color: var(--accent);
        }

        /* === SCREENS === */
        .screen { display: none; }
        .screen.active { display: block; }

        /* === GRID === */
        .lots-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .lot-card {
            background: var(--card);
            border-radius: var(--radius);
            padding: 14px 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            border: 1px solid var(--border);
            cursor: pointer;
            transition: transform 0.15s, border-color 0.2s;
            position: relative;
        }
        .lot-card:hover {
            transform: translateY(-2px);
            border-color: var(--accent);
        }

        /* Badge */
        .lot-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            font-size: 10px;
            padding: 2px 8px;
            border-radius: 999px;
            font-weight: 700;
        }
        .badge-hot { background: var(--red); color: #fff; }
        .badge-new { background: var(--green); color: #fff; }

        .lot-image-placeholder {
            width: 72px;
            height: 72px;
            border-radius: 50%;
            border: 2px solid var(--accent);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            background: rgba(108,92,231,0.1);
        }

        .lot-name {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 2px;
        }
        .lot-desc {
            font-size: 11px;
            color: var(--text-dim);
            text-align: center;
            min-height: 18px;
        }
        .lot-price {
            font-size: 15px;
            font-weight: 700;
            color: var(--green);
            margin-top: 6px;
            margin-bottom: 8px;
        }

        /* === BUTTONS === */
        .btn {
            padding: 10px 16px;
            font-size: 13px;
            font-weight: 600;
            border-radius: 999px;
            border: none;
            cursor: pointer;
            transition: transform 0.1s, opacity 0.2s;
        }
        .btn:active { transform: scale(0.96); }

        .btn-accent {
            background: var(--accent);
            color: #fff;
        }
        .btn-accent:hover { background: var(--accent-hover); }

        .btn-green {
            background: var(--green);
            color: #fff;
        }
        .btn-outline {
            background: transparent;
            color: var(--accent);
            border: 1px solid var(--accent);
        }
        .btn-gray {
            background: var(--border);
            color: var(--text);
        }

        .hint {
            margin-top: 18px;
            font-size: 11px;
            color: var(--text-dim);
            text-align: center;
        }

        /* === DETAIL === */
        .detail-card {
            background: var(--card);
            border-radius: var(--radius);
            padding: 20px;
            border: 1px solid var(--border);
        }

        .detail-top {
            display: flex;
            gap: 14px;
            margin-bottom: 14px;
            align-items: center;
        }
        .detail-image {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            border: 2px solid var(--accent);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            background: rgba(108,92,231,0.1);
            flex-shrink: 0;
        }
        .detail-title { font-size: 20px; font-weight: 700; margin-bottom: 4px; }
        .detail-desc { font-size: 13px; color: var(--text-dim); line-height: 1.5; }

        .qty-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 14px;
            padding: 12px;
            background: var(--bg);
            border-radius: 12px;
        }
        .qty-controls { display: flex; align-items: center; gap: 12px; }
        .qty-btn {
            width: 36px; height: 36px;
            border-radius: 50%;
            border: 1px solid var(--border);
            background: var(--card);
            color: var(--text);
            font-size: 20px;
            line-height: 0;
            cursor: pointer;
            transition: background 0.2s;
        }
        .qty-btn:hover { background: var(--accent); }
        .qty-value { min-width: 36px; text-align: center; font-weight: 700; font-size: 18px; }
        .detail-price { font-size: 18px; font-weight: 700; color: var(--green); }

        .detail-actions {
            display: flex;
            gap: 10px;
            margin-top: 16px;
        }

        /* === PAY === */
        .pay-summary {
            background: var(--card);
            border-radius: var(--radius);
            padding: 20px;
            border: 1px solid var(--border);
        }
        .pay-row {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border);
        }
        .pay-row:last-child { border-bottom: none; }
        .pay-row.total {
            font-weight: 700;
            font-size: 17px;
            margin-top: 8px;
            color: var(--green);
            border-bottom: none;
        }

        /* Payment method selector */
        .pay-methods {
            margin-top: 16px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .pay-method-btn {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: var(--card);
            color: var(--text);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: border-color 0.2s, background 0.2s;
        }
        .pay-method-btn:hover {
            border-color: var(--accent);
        }
        .pay-method-btn.selected {
            border-color: var(--accent);
            background: rgba(108,92,231,0.15);
        }
        .pay-method-btn .pm-icon { font-size: 20px; }
        .pay-method-btn .pm-info { display: flex; flex-direction: column; }
        .pay-method-btn .pm-name { font-size: 14px; }
        .pay-method-btn .pm-desc { font-size: 10px; color: var(--text-dim); font-weight: 400; }

        .pay-actions {
            margin-top: 16px;
            display: flex;
            gap: 10px;
        }

        /* === TOAST === */
        .toast {
            position: fixed;
            bottom: 80px;
            left: 50%; transform: translateX(-50%);
            padding: 10px 20px;
            border-radius: 12px;
            background: var(--accent);
            color: #fff;
            font-size: 13px;
            font-weight: 600;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            z-index: 999;
        }
        .toast.show { opacity: 1; }

        /* === CART BADGE === */
        .cart-float {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 56px; height: 56px;
            border-radius: 50%;
            background: var(--accent);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 16px rgba(108,92,231,0.4);
            transition: transform 0.2s;
            z-index: 100;
        }
        .cart-float:hover { transform: scale(1.1); }
        .cart-count {
            position: absolute;
            top: -4px; right: -4px;
            background: var(--red);
            color: #fff;
            font-size: 11px;
            font-weight: 700;
            width: 20px; height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* === CART SCREEN === */
        .cart-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            background: var(--card);
            border-radius: 12px;
            border: 1px solid var(--border);
            margin-bottom: 8px;
        }
        .cart-item-left { display: flex; align-items: center; gap: 10px; }
        .cart-item-icon { font-size: 24px; }
        .cart-item-name { font-weight: 600; font-size: 14px; }
        .cart-item-meta { font-size: 12px; color: var(--text-dim); }
        .cart-item-remove {
            background: none; border: none;
            color: var(--red); font-size: 18px; cursor: pointer;
        }
        .cart-empty { text-align: center; color: var(--text-dim); padding: 40px 0; font-size: 14px; }

        @media (max-width: 360px) {
            .lots-grid { grid-template-columns: 1fr; }
            .detail-top { flex-direction: column; align-items: flex-start; }
        }
    </style>
</head>
<body>
<main>
    <header>
        <div class="header-left">
            <span class="logo">üõí</span>
            <h1>–ú–∞–≥–∞–∑–∏–Ω</h1>
        </div>
        <div id="user-greeting"></div>
    </header>

    <!-- –ü–û–ò–°–ö -->
    <input type="text" class="search-bar" id="search-input" placeholder="üîç –ù–∞–π—Ç–∏ —Ç–æ–≤–∞—Ä..." />

    <!-- –ö–ê–¢–ï–ì–û–†–ò–ò -->
    <div class="category-tabs" id="category-tabs">
        <div class="cat-tab active" data-cat="all">–í—Å–µ</div>
        <div class="cat-tab" data-cat="digital">–¶–∏—Ñ—Ä–æ–≤–æ–µ</div>
        <div class="cat-tab" data-cat="physical">–§–∏–∑–∏—á–µ—Å–∫–∏–µ</div>
        <div class="cat-tab" data-cat="service">–£—Å–ª—É–≥–∏</div>
    </div>

    <!-- –°—Ç—Ä–∞–Ω–∏—Ü–∞ 1: —Å–ø–∏—Å–æ–∫ -->
    <section id="screen-list" class="screen active">
        <div class="lots-grid" id="lots-grid"></div>
        <div class="hint">–ù–∞–∂–º–∏ –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫—É ‚Üí –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –∏ –æ–ø–ª–∞—Ç–∞</div>
    </section>

    <!-- –°—Ç—Ä–∞–Ω–∏—Ü–∞ 2: –∫–∞—Ä—Ç–æ—á–∫–∞ —Ç–æ–≤–∞—Ä–∞ -->
    <section id="screen-detail" class="screen">
        <div class="detail-card">
            <div class="detail-top">
                <div class="detail-image" id="detail-icon"></div>
                <div>
                    <div id="detail-title" class="detail-title"></div>
                    <div id="detail-desc" class="detail-desc"></div>
                </div>
            </div>

            <div class="qty-row">
                <div class="qty-controls">
                    <button class="qty-btn" data-delta="-1">‚àí</button>
                    <div id="qty-value" class="qty-value">1</div>
                    <button class="qty-btn" data-delta="1">+</button>
                </div>
                <div id="detail-price" class="detail-price"></div>
            </div>

            <div class="detail-actions">
                <button id="btn-back-from-detail" class="btn btn-gray" style="flex:1;">‚Üê –ù–∞–∑–∞–¥</button>
                <button id="btn-add-cart" class="btn btn-accent" style="flex:1;">üõí –í –∫–æ—Ä–∑–∏–Ω—É</button>
                <button id="btn-to-pay" class="btn btn-green" style="flex:1;">–ö –æ–ø–ª–∞—Ç–µ ‚Üí</button>
            </div>
        </div>
    </section>

    <!-- –°—Ç—Ä–∞–Ω–∏—Ü–∞ 3: –∫–æ—Ä–∑–∏–Ω–∞ -->
    <section id="screen-cart" class="screen">
        <h2 style="margin-bottom:14px;font-size:18px;">üõí –ö–æ—Ä–∑–∏–Ω–∞</h2>
        <div id="cart-items"></div>
        <div id="cart-total" style="font-size:17px;font-weight:700;color:var(--green);margin:12px 0;"></div>
        <div class="detail-actions">
            <button id="btn-back-from-cart" class="btn btn-gray" style="flex:1;">‚Üê –ú–∞–≥–∞–∑–∏–Ω</button>
            <button id="btn-cart-checkout" class="btn btn-green" style="flex:2;">–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</button>
        </div>
    </section>

    <!-- –°—Ç—Ä–∞–Ω–∏—Ü–∞ 4: –æ–ø–ª–∞—Ç–∞ -->
    <section id="screen-pay" class="screen">
        <div class="pay-summary">
            <div class="pay-row">
                <span>–¢–æ–≤–∞—Ä</span>
                <span id="pay-name"></span>
            </div>
            <div class="pay-row">
                <span>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</span>
                <span id="pay-qty"></span>
            </div>
            <div class="pay-row">
                <span>–¶–µ–Ω–∞ –∑–∞ —à—Ç.</span>
                <span id="pay-price"></span>
            </div>
            <div class="pay-row total">
                <span>–ò—Ç–æ–≥–æ</span>
                <span id="pay-total"></span>
            </div>
        </div>

        <!-- –í—ã–±–æ—Ä –º–µ—Ç–æ–¥–∞ –æ–ø–ª–∞—Ç—ã -->
        <div class="pay-methods" id="pay-methods">
            <div class="pay-method-btn selected" data-method="tonconnect">
                <span class="pm-icon">üíé</span>
                <div class="pm-info">
                    <span class="pm-name">TON Connect</span>
                    <span class="pm-desc">Tonkeeper, MyTonWallet, OpenMask</span>
                </div>
            </div>
            <div class="pay-method-btn" data-method="cryptobot">
                <span class="pm-icon">ü§ñ</span>
                <div class="pm-info">
                    <span class="pm-name">CryptoBot (Crypto Pay)</span>
                    <span class="pm-desc">BTC, ETH, USDT, TON, LTC, BNB, TRX, USDC</span>
                </div>
            </div>
            <div class="pay-method-btn" data-method="xrocket">
                <span class="pm-icon">üöÄ</span>
                <div class="pm-info">
                    <span class="pm-name">xRocket</span>
                    <span class="pm-desc">USDT, TON, BTC –∏ –¥—Ä—É–≥–∏–µ</span>
                </div>
            </div>
            <div class="pay-method-btn" data-method="stars">
                <span class="pm-icon">‚≠ê</span>
                <div class="pm-info">
                    <span class="pm-name">Telegram Stars</span>
                    <span class="pm-desc">–û–ø–ª–∞—Ç–∞ Stars –≤–Ω—É—Ç—Ä–∏ Telegram</span>
                </div>
            </div>
        </div>

        <div class="pay-actions">
            <button id="btn-back-from-pay" class="btn btn-gray" style="flex:1;">‚Üê –ù–∞–∑–∞–¥</button>
            <button id="btn-confirm-pay" class="btn btn-green" style="flex:2;">üí∞ –û–ø–ª–∞—Ç–∏—Ç—å</button>
        </div>
    </section>
</main>

<!-- Floating cart button -->
<div class="cart-float" id="cart-float" style="display:none;">
    üõí
    <div class="cart-count" id="cart-count">0</div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script>
    // ===================== INIT =====================
    const tg = window.Telegram ? Telegram.WebApp : null;
    let tonConnectUI = null;

    // ===================== PRODUCTS =====================
    const products = [
        { id: 1, name: "VPN –ü–æ–¥–ø–∏—Å–∫–∞", price: 500, description: "–ë–µ–∑–ª–∏–º–∏—Ç–Ω—ã–π VPN –Ω–∞ 30 –¥–Ω–µ–π", category: "digital", icon: "üîê", badge: "hot" },
        { id: 2, name: "–î–∏–∑–∞–π–Ω –ª–æ–≥–æ",  price: 1500, description: "–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –ª–æ–≥–æ—Ç–∏–ø –¥–ª—è –±—Ä–µ–Ω–¥–∞", category: "service", icon: "üé®", badge: "new" },
        { id: 3, name: "NFT –ö–æ–ª–ª–µ–∫—Ü–∏—è", price: 900, description: "–£–Ω–∏–∫–∞–ª—å–Ω—ã–π —Ü–∏—Ñ—Ä–æ–≤–æ–π –∞—Ä—Ç", category: "digital", icon: "üñºÔ∏è", badge: "" },
        { id: 4, name: "–ú–µ—Ä—á —Ñ—É—Ç–±–æ–ª–∫–∞", price: 2000, description: "–•–ª–æ–ø–æ–∫ 100%, –ø–µ—á–∞—Ç—å premium", category: "physical", icon: "üëï", badge: "" },
        { id: 5, name: "–ë–æ—Ç –Ω–∞ –∑–∞–∫–∞–∑",  price: 5000, description: "Telegram-–±–æ—Ç –ø–æ–¥ –≤–∞—à–∏ –Ω—É–∂–¥—ã", category: "service", icon: "ü§ñ", badge: "hot" },
        { id: 6, name: "–ö—Ä–∏–ø—Ç–æ-–∫—É—Ä—Å",   price: 3000, description: "–û–±—É—á–µ–Ω–∏–µ —Ç—Ä–µ–π–¥–∏–Ω–≥—É 10 —É—Ä–æ–∫–æ–≤", category: "digital", icon: "üìö", badge: "new" }
    ];

    // ===================== STATE =====================
    let currentProduct = null;
    let currentQty = 1;
    let selectedPayMethod = "tonconnect";
    let cart = [];
    let activeCategory = "all";

    // ===================== DOM =====================
    const screens = {
        list:   document.getElementById("screen-list"),
        detail: document.getElementById("screen-detail"),
        pay:    document.getElementById("screen-pay"),
        cart:   document.getElementById("screen-cart")
    };

    const $ = id => document.getElementById(id);

    // ===================== 1. SCREEN NAVIGATION =====================
    function showScreen(name) {
        Object.values(screens).forEach(s => s.classList.remove("active"));
        screens[name].classList.add("active");
        window.scrollTo({ top: 0, behavior: "smooth" });
    }

    // ===================== 2. TOAST NOTIFICATIONS =====================
    function showToast(msg) {
        const t = $("toast");
        t.textContent = msg;
        t.classList.add("show");
        setTimeout(() => t.classList.remove("show"), 2000);
    }

    // ===================== 3. RENDER PRODUCTS =====================
    function renderLots(filter = "", cat = "all") {
        const grid = $("lots-grid");
        grid.innerHTML = "";
        const filtered = products.filter(p => {
            const matchCat = cat === "all" || p.category === cat;
            const matchSearch = p.name.toLowerCase().includes(filter.toLowerCase()) ||
                                p.description.toLowerCase().includes(filter.toLowerCase());
            return matchCat && matchSearch;
        });

        if (filtered.length === 0) {
            grid.innerHTML = '<div class="hint" style="grid-column:1/-1;padding:40px 0;">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ üòî</div>';
            return;
        }

        filtered.forEach(p => {
            const card = document.createElement("article");
            card.className = "lot-card";
            card.dataset.id = p.id;

            let badgeHTML = "";
            if (p.badge === "hot") badgeHTML = '<div class="lot-badge badge-hot">üî• –•–ò–¢</div>';
            if (p.badge === "new") badgeHTML = '<div class="lot-badge badge-new">NEW</div>';

            card.innerHTML = `
                ${badgeHTML}
                <div class="lot-image-placeholder">${p.icon}</div>
                <div class="lot-name">${p.name}</div>
                <div class="lot-desc">${p.description}</div>
                <div class="lot-price">${p.price}‚ÇΩ</div>
                <button class="btn btn-outline" style="width:100%;">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</button>
            `;
            grid.appendChild(card);
        });
    }

    // ===================== 4. DETAIL =====================
    function openDetail(productId) {
        const p = products.find(x => x.id === productId);
        if (!p) return;

        currentProduct = p;
        currentQty = 1;
        $("qty-value").textContent = "1";
        $("detail-title").textContent = p.name;
        $("detail-desc").textContent = p.description;
        $("detail-price").textContent = `${p.price}‚ÇΩ / —à—Ç.`;
        $("detail-icon").textContent = p.icon;

        showScreen("detail");
    }

    // ===================== 5. QUANTITY =====================
    function updateQty(delta) {
        let next = currentQty + delta;
        if (next < 1) next = 1;
        if (next > 99) next = 99;
        currentQty = next;
        $("qty-value").textContent = String(currentQty);
    }

    // ===================== 6. CART =====================
    function addToCart() {
        if (!currentProduct) return;
        const existing = cart.find(c => c.product.id === currentProduct.id);
        if (existing) {
            existing.qty += currentQty;
        } else {
            cart.push({ product: { ...currentProduct }, qty: currentQty });
        }
        updateCartBadge();
        showToast(`${currentProduct.icon} ${currentProduct.name} –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∫–æ—Ä–∑–∏–Ω—É!`);
        showScreen("list");
    }

    function removeFromCart(productId) {
        cart = cart.filter(c => c.product.id !== productId);
        updateCartBadge();
        renderCart();
    }

    function updateCartBadge() {
        const total = cart.reduce((s, c) => s + c.qty, 0);
        $("cart-count").textContent = total;
        $("cart-float").style.display = total > 0 ? "flex" : "none";
    }

    function renderCart() {
        const container = $("cart-items");
        if (cart.length === 0) {
            container.innerHTML = '<div class="cart-empty">–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞ üõí</div>';
            $("cart-total").textContent = "";
            return;
        }
        let html = "";
        let grandTotal = 0;
        cart.forEach(c => {
            const subtotal = c.product.price * c.qty;
            grandTotal += subtotal;
            html += `
                <div class="cart-item">
                    <div class="cart-item-left">
                        <span class="cart-item-icon">${c.product.icon}</span>
                        <div>
                            <div class="cart-item-name">${c.product.name}</div>
                            <div class="cart-item-meta">${c.qty} —à—Ç. √ó ${c.product.price}‚ÇΩ = ${subtotal}‚ÇΩ</div>
                        </div>
                    </div>
                    <button class="cart-item-remove" data-remove="${c.product.id}">‚úï</button>
                </div>
            `;
        });
        container.innerHTML = html;
        $("cart-total").textContent = `–ò—Ç–æ–≥–æ: ${grandTotal}‚ÇΩ`;

        container.querySelectorAll("[data-remove]").forEach(btn => {
            btn.addEventListener("click", () => removeFromCart(Number(btn.dataset.remove)));
        });
    }

    // ===================== 7. PAY SCREEN =====================
    function preparePayScreen() {
        if (!currentProduct) return;
        const total = currentProduct.price * currentQty;

        $("pay-name").textContent  = currentProduct.name;
        $("pay-qty").textContent   = `${currentQty} —à—Ç.`;
        $("pay-price").textContent = `${currentProduct.price}‚ÇΩ`;
        $("pay-total").textContent = `${total}‚ÇΩ`;

        showScreen("pay");
    }

    function preparePayFromCart() {
        if (cart.length === 0) {
            showToast("–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞!");
            return;
        }
        const names = cart.map(c => c.product.name).join(", ");
        const totalQty = cart.reduce((s, c) => s + c.qty, 0);
        const grandTotal = cart.reduce((s, c) => s + c.product.price * c.qty, 0);

        $("pay-name").textContent  = names;
        $("pay-qty").textContent   = `${totalQty} —à—Ç.`;
        $("pay-price").textContent = "‚Äî";
        $("pay-total").textContent = `${grandTotal}‚ÇΩ`;

        currentProduct = { id: 0, name: names, price: grandTotal, description: "–ó–∞–∫–∞–∑ –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã", icon: "üõí" };
        currentQty = 1;

        showScreen("pay");
    }

    // ===================== 8. PAYMENT METHOD SELECT =====================
    document.querySelectorAll(".pay-method-btn").forEach(btn => {
        btn.addEventListener("click", () => {
            document.querySelectorAll(".pay-method-btn").forEach(b => b.classList.remove("selected"));
            btn.classList.add("selected");
            selectedPayMethod = btn.dataset.method;
        });
    });

    // ===================== 9. PAY HANDLERS =====================

    // 9a. TON Connect
    async function payTonConnect() {
        if (!tonConnectUI) {
            showToast("‚ö†Ô∏è TON Connect –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω");
            return;
        }
        const totalFiat = currentProduct.price * currentQty;
        const totalTon = (totalFiat * 0.013) / 1.20;

        const tx = {
            validUntil: Math.floor(Date.now() / 1000) + 300,
            messages: [{
                address: "YOUR_TON_WALLET_ADDRESS", // ‚Üê –ó–ê–ú–ï–ù–ò
                amount: Math.round(totalTon * 1e9).toString()
            }]
        };

        try {
            const result = await tonConnectUI.sendTransaction(tx);
            sendOrderToBot("ton_connect", result.boc || "ok");
        } catch (e) {
            showToast("‚ùå –û–ø–ª–∞—Ç–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞");
        }
    }

    // 9b. CryptoBot (Crypto Pay @CryptoBot)
    function payCryptoBot() {
        const totalFiat = currentProduct.price * currentQty;
        const orderData = {
            type: "create_invoice",
            method: "cryptobot",
            name: currentProduct.name,
            quantity: currentQty,
            total_rub: totalFiat
        };
        if (tg) {
            tg.sendData(JSON.stringify(orderData));
            showToast("üì® –ó–∞–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –±–æ—Ç—É ‚Äî –æ–∂–∏–¥–∞–π —Å—Å—ã–ª–∫—É –Ω–∞ –æ–ø–ª–∞—Ç—É");
        } else {
            showToast("CryptoBot: –±–æ—Ç —Å–æ–∑–¥–∞—Å—Ç –∏–Ω–≤–æ–π—Å —á–µ—Ä–µ–∑ @CryptoBot API");
            alert(JSON.stringify(orderData, null, 2));
        }
    }

    // 9c. xRocket
    function payXRocket() {
        const totalFiat = currentProduct.price * currentQty;
        const orderData = {
            type: "create_invoice",
            method: "xrocket",
            name: currentProduct.name,
            quantity: currentQty,
            total_rub: totalFiat
        };
        if (tg) {
            tg.sendData(JSON.stringify(orderData));
            showToast("üöÄ –ó–∞–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω ‚Äî –æ–∂–∏–¥–∞–π —Å—Å—ã–ª–∫—É xRocket");
        } else {
            showToast("xRocket: –±–æ—Ç —Å–æ–∑–¥–∞—Å—Ç –∏–Ω–≤–æ–π—Å —á–µ—Ä–µ–∑ Rocket Pay API");
            alert(JSON.stringify(orderData, null, 2));
        }
    }

    // 9d. Telegram Stars
    function payStars() {
        const totalFiat = currentProduct.price * currentQty;
        const orderData = {
            type: "create_invoice",
            method: "stars",
            name: currentProduct.name,
            quantity: currentQty,
            total_rub: totalFiat
        };
        if (tg) {
            tg.sendData(JSON.stringify(orderData));
            showToast("‚≠ê –ó–∞–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω ‚Äî –±–æ—Ç —Å–æ–∑–¥–∞—Å—Ç Stars-–∏–Ω–≤–æ–π—Å");
        } else {
            showToast("Stars: –±–æ—Ç —Å–æ–∑–¥–∞—Å—Ç –∏–Ω–≤–æ–π—Å —á–µ—Ä–µ–∑ Bot Payments API (XTR)");
            alert(JSON.stringify(orderData, null, 2));
        }
    }

    // Universal pay dispatcher
    function confirmPay() {
        switch (selectedPayMethod) {
            case "tonconnect": payTonConnect(); break;
            case "cryptobot":  payCryptoBot();  break;
            case "xrocket":    payXRocket();    break;
            case "stars":      payStars();      break;
            default: showToast("–í—ã–±–µ—Ä–∏ —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã");
        }
    }

    // ===================== 10. SEND ORDER TO BOT =====================
    function sendOrderToBot(method, txRef) {
        const totalFiat = currentProduct.price * currentQty;
        const payload = {
            type: "order_paid",
            method: method,
            tx_ref: txRef,
            order: {
                name: currentProduct.name,
                price: currentProduct.price,
                quantity: currentQty,
                total: totalFiat
            }
        };
        if (tg) {
            tg.sendData(JSON.stringify(payload));
            tg.close();
        } else {
            alert("–ó–∞–∫–∞–∑: " + JSON.stringify(payload, null, 2));
        }
    }

    // ===================== EVENTS =====================

    // Product grid click
    $("lots-grid").addEventListener("click", (e) => {
        const card = e.target.closest(".lot-card");
        if (!card) return;
        openDetail(Number(card.dataset.id));
    });

    // Qty buttons
    document.querySelectorAll(".qty-btn").forEach(btn => {
        btn.addEventListener("click", () => updateQty(Number(btn.dataset.delta)));
    });

    // Navigation
    $("btn-back-from-detail").addEventListener("click", () => showScreen("list"));
    $("btn-to-pay").addEventListener("click", preparePayScreen);
    $("btn-add-cart").addEventListener("click", addToCart);
    $("btn-back-from-pay").addEventListener("click", () => showScreen("detail"));
    $("btn-confirm-pay").addEventListener("click", confirmPay);

    // Cart
    $("cart-float").addEventListener("click", () => { renderCart(); showScreen("cart"); });
    $("btn-back-from-cart").addEventListener("click", () => showScreen("list"));
    $("btn-cart-checkout").addEventListener("click", preparePayFromCart);

    // Search (debounced)
    let searchTimer;
    $("search-input").addEventListener("input", (e) => {
        clearTimeout(searchTimer);
        searchTimer = setTimeout(() => renderLots(e.target.value, activeCategory), 250);
    });

    // Category tabs
    $("category-tabs").addEventListener("click", (e) => {
        const tab = e.target.closest(".cat-tab");
        if (!tab) return;
        document.querySelectorAll(".cat-tab").forEach(t => t.classList.remove("active"));
        tab.classList.add("active");
        activeCategory = tab.dataset.cat;
        renderLots($("search-input").value, activeCategory);
    });

    // ===================== STARTUP =====================
    renderLots();

    if (tg) {
        tg.ready();
        tg.expand();

        // Greeting
        const user = tg.initDataUnsafe?.user;
        if (user) {
            $("user-greeting").textContent = `–ü—Ä–∏–≤–µ—Ç, ${user.first_name}! üëã`;
        }

        // Theme sync
        document.documentElement.style.setProperty("--bg", tg.themeParams?.bg_color || "#0f1117");
        document.documentElement.style.setProperty("--card", tg.themeParams?.secondary_bg_color || "#1a1d27");
    }

    // Init TON Connect UI
    window.addEventListener("load", () => {
        if (window.TON_CONNECT_UI) {
            try {
                tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
                    manifestUrl: "https://eclectic-cranachan-57cc2a.netlify.app/tonconnect-manifest.json"
                });
                console.log("TON Connect UI ready");
            } catch (e) {
                console.warn("TON Connect init error:", e);
            }
        }
    });
</script>
</body>
</html>







